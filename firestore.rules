rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for validation
    function isValidGameId(gameId) {
      return gameId is string && gameId.size() == 6 && gameId.matches('[A-Z0-9]+');
    }
    
    function isValidPlayerName(name) {
      return name is string && name.size() >= 1 && name.size() <= 50;
    }
    
    function isRecentTimestamp(ts) {
      return ts is number && 
             ts > (request.time.toMillis() - 300000) && // Not older than 5 minutes (more lenient)
             ts < (request.time.toMillis() + 60000); // Allow 1 minute in future
    }
    
    function isValidLobbyData(data) {
      return data.keys().hasAll(['id', 'players', 'hostId', 'createdAt']) &&
             data.id is string &&
             data.players is list &&
             data.players.size() >= 1 && data.players.size() <= 10 && // Max 10 players
             data.hostId is string &&
             data.createdAt is number &&
             (!('ttl' in data) || data.ttl is timestamp);
    }
    
    function isValidGameData(data) {
      return data.keys().hasAll(['id', 'phase', 'players', 'currentRound', 'totalRounds', 'createdAt', 'hostId']) &&
             data.phase in ['drafting', 'scoring'] &&
             data.players is list &&
             data.players.size() >= 2 && data.players.size() <= 10 &&
             data.currentRound is number && data.currentRound >= 1 && data.currentRound <= 50 &&
             data.totalRounds is number && data.totalRounds >= 1 && data.totalRounds <= 50 &&
             data.createdAt is number &&
             (!('ttl' in data) || data.ttl is timestamp);
    }
    
    // Lobbies collection - temporarily permissive for debugging
    match /lobbies/{lobbyId} {
      allow read, write: if true;
    }
    
    // Games collection - temporarily permissive for debugging  
    match /games/{gameId} {
      allow read, write: if true;
    }
    
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
